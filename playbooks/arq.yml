---
- name: Configuração do servidor de arquivos (arq)
  hosts: arq
  become: yes

  vars:
    dominio: caua.joao.devops
    ip_arq: 192.168.56.121
    ip_db: 192.168.56.105
    ip_app: 192.168.56.115
    gateway: 192.168.56.1
    rede: 192.168.56.0/24
    interface_dhcp: "eth1"
    usuarios:
      - caua
      - joao
    vg_name: "ifpb_vg"
    lv_name: "ifpb_lv"
    mount_point: "/dados"
    nfs_dir: "/dados/nfs"

  tasks:
    # ================= DHCP =================
    - name: Instalar servidor DHCP
      apt:
        name: isc-dhcp-server
        state: present
        update_cache: yes

    - name: Configurar DHCP
      template:
        src: dhcpd.conf.j2
        dest: /etc/dhcp/dhcpd.conf
        mode: '0644'
      notify: restart dhcp

    - name: Configurar interface do DHCP
      lineinfile:
        path: /etc/default/isc-dhcp-server
        regexp: '^INTERFACESv4='
        line: 'INTERFACESv4="{{ interface_dhcp }}"'
        state: present
        backup: yes
      notify: restart dhcp

    # ================= DNS =================
    - name: Instalar Bind9
      apt:
        name: bind9
        state: present
        update_cache: yes

    - name: Configurar opções do Bind (forwarders)
      template:
        src: named.conf.options.j2
        dest: /etc/bind/named.conf.options
        mode: '0644'
      notify: restart bind9

    - name: Configurar zonas no named.conf.local
      template:
        src: named.conf.local.j2
        dest: /etc/bind/named.conf.local
        mode: '0644'
      notify: restart bind9

    - name: Criar zona direta
      template:
        src: db.dominio.j2
        dest: "/etc/bind/db.{{ dominio}}"
        mode: '0644'
      notify: restart bind9

    - name: Criar zona reversa 
      template:
        src: db.reversa.j2
        dest: /etc/bind/db.56.168.192
        mode: '0644'
      notify: restart bind9

    # ================= LVM =================
    - name: Instalar pacotes necessários para LVM
      apt:
        name:
          - parted
          - lvm2
          - e2fsprogs
        state: present
        update_cache: yes

    - name: Verificar discos disponíveis
      set_fact:
        discos_disponiveis: "{{ ['sdb', 'sdc', 'sdd'] | select('in', ansible_facts['devices'].keys()) | list }}"

    - name: Criar partições LVM nos discos disponíveis
      parted:
        device: "/dev/{{ item }}"
        label: gpt
        number: 1
        state: present
        part_start: "1MiB"
        part_end: "100%"
      loop: "{{ discos_disponiveis }}"
      when: discos_disponiveis | length > 0

    - name: Criar Physical Volumes (PVs)
      shell: |
        if [ -b /dev/{{ item }}1 ] && ! pvs /dev/{{ item }}1 2>/dev/null; then
          pvcreate /dev/{{ item }}1 --yes
        fi
      loop: "{{ discos_disponiveis }}"
      when: discos_disponiveis | length > 0

    - name: Criar Volume Group ifpb_vg
      shell: |
        if ! vgs ifpb_vg 2>/dev/null; then
          PVS=""
          {% for disco in ['sdb', 'sdc', 'sdd'] %}
          if [ -b /dev/{{ disco }}1 ] && pvs /dev/{{ disco }}1 2>/dev/null; then
            PVS="$PVS /dev/{{ disco }}1"
          fi
          {% endfor %}
          if [ -n "$PVS" ]; then
            vgcreate ifpb_vg $PVS
          fi
        fi
      when: discos_disponiveis | length > 0

    - name: Criar Logical Volume ifpb_lv
      shell: |
        if ! lvs ifpb_vg/ifpb_lv 2>/dev/null; then
          if lvcreate -L 15G -n ifpb_lv ifpb_vg 2>/dev/null; then
            echo "created_15GB"
          else
            lvcreate -l 100%FREE -n ifpb_lv ifpb_vg 2>/dev/null && echo "created_with_free_space"
          fi
        fi
      when: discos_disponiveis | length > 0

    - name: Formatar LV com ext4
      filesystem:
        fstype: ext4
        dev: /dev/ifpb_vg/ifpb_lv
        force: no
      when: discos_disponiveis | length > 0

    - name: Criar diretório de montagem
      file:
        path: "{{ mount_point }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Montar LV no diretório
      mount:
        path: "{{ mount_point }}"
        src: /dev/ifpb_vg/ifpb_lv
        fstype: ext4
        state: mounted
        opts: defaults
      when: discos_disponiveis | length > 0

    # ================= NFS =================
    - name: Instalar NFS Server
      apt:
        name: nfs-kernel-server
        state: present
        update_cache: yes

    - name: Criar usuário nfs-ifpb
      user:
        name: nfs-ifpb
        shell: /usr/sbin/nologin
        system: yes
        state: present
        create_home: no

    - name: Garantir que diretório NFS existe
      file:
        path: "{{ nfs_dir }}"
        state: directory
        owner: nfs-ifpb
        group: nfs-ifpb
        mode: '0775'

    - name: Obter UID do usuário nfs-ifpb
      shell: "id -u nfs-ifpb"
      register: nfs_uid_cmd
      changed_when: false
      ignore_errors: yes

    - name: Obter GID do usuário nfs-ifpb
      shell: "id -g nfs-ifpb"
      register: nfs_gid_cmd
      changed_when: false
      ignore_errors: yes

    - name: Definir UID e GID (com fallback)
      set_fact:
        nfs_uid: "{{ nfs_uid_cmd.stdout | default('65534') }}"
        nfs_gid: "{{ nfs_gid_cmd.stdout | default('65534') }}"

    - name: Configurar exports NFS
      copy:
        dest: /etc/exports
        content: |
          # Compartilhamento NFS
          {{ nfs_dir }} {{ rede }}(rw,sync,no_subtree_check,all_squash,anonuid={{ nfs_uid }},anongid={{ nfs_gid }})
        owner: root
        group: root
        mode: '0644'
      notify: restart nfs-server  # Nome correto do handler

    # ================= GERENCIAMENTO DE SERVIÇOS =================
    - name: Garantir que serviços iniciam no boot
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - isc-dhcp-server
        - bind9
        - nfs-kernel-server

    # ================= VERIFICAÇÕES =================
    - name: Verificar status LVM
      shell: |
        echo "PVs:"; pvs 2>/dev/null || echo "Nenhum"
        echo "VGs:"; vgs 2>/dev/null || echo "Nenhum"
        echo "LVs:"; lvs 2>/dev/null || echo "Nenhum"
      register: lvm_check
      changed_when: false

    - name: Verificar NFS
      shell: |
        echo "Exports:"
        cat /etc/exports 2>/dev/null || echo "Arquivo não existe"
        echo "Status exportfs:"
        exportfs -v 2>/dev/null || echo "Nenhum export ativo"
      register: nfs_check
      changed_when: false

  handlers:
    - name: restart dhcp
      systemd:
        name: isc-dhcp-server
        state: restarted

    - name: restart bind9
      systemd:
        name: bind9
        state: restarted

    # CORREÇÃO: Handler com nome correto
    - name: restart nfs-server
      systemd:
        name: nfs-kernel-server
        state: restarted
