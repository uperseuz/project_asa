---
- name: Configuração básica para todas as máquinas
  hosts: all
  become: yes

  vars:
    ntp_servers:
      - pool.ntp.br  
  
  tasks:

    - name: Atualizar apt cache e fazer upgrade do sistema
      apt:
        update_cache: yes
        upgrade: yes

#Faz a instalação do pacote chrony
    - name: Instalar chrony
      apt:
        name: chrony
        state: present

    # Configura o servidor NTP específico
    - name: Configurar servidor NTP para pool.ntp.br
      lineinfile:
        path: /etc/chrony/chrony.conf  # Arquivo de configuração do chrony
        regexp: '^pool '   # Procura linhas que começam com 'pool '
        line: 'pool pool.ntp.br iburst'  # Substitui pela configuração desejada
        state: present     # Garante que a linha existe

    # Aplica as mudanças reiniciando o serviço
    - name: Reiniciar chrony
      systemd:
        name: chrony
        state: started
        enabled: yes

#Adiciona o fuso da maquina para o de Recife
    - name: Configurar timezone
      timezone:
        name: America/Recife

    # Cria o grupo 'ifpb' para organização dos usuários
    - name: Criar grupo ifpb
      group:
        name: ifpb         # Nome do grupo
        state: present     # Garante que o grupo existe



    - name: Criar usuários do grupo
      user:
      name: "{{ item }}" # Variável que será substituída pelos itens do loop
        groups: ifpb       # Adiciona o usuário ao grupo ifpb
        append: yes        # Adiciona ao grupo sem remover outros grupos
        shell: /bin/bash   # Shell padrão do usuário
      loop:
        - caua
        - joao

    # Instala o servidor SSH se não estiver presente
    - name: Instalar openssh-server
      apt:
        name: openssh-server
        state: present

    #Segurança: Desativa autenticação por senha
    - name: Configurar SSH para permitir apenas autenticação por chave
      lineinfile:
        path: /etc/ssh/sshd_config  # Arquivo de configuração do SSH
        regexp: '^PasswordAuthentication'  # Procura configuração de autenticação por senha
        line: 'PasswordAuthentication no'  # Desativa autenticação por senha
        state: present

    #Segurança: Bloqueia acesso root remoto
    - name: Bloquear acesso root via SSH
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'  # Configuração de acesso root
        line: 'PermitRootLogin no'  # Bloqueia acesso root via SSH
        state: present

    # Segurança: Restringe grupos permitidos
    - name: Permitir apenas usuários dos grupos vagrant e ifpb
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^AllowGroups'  # Configuração de grupos permitidos
        line: 'AllowGroups vagrant ifpb'  # Apenas usuários destes grupos podem acessar
        state: present

    # Banner de Aviso Legal (requisito do projeto)
    - name: Configurar banner de SSH
      copy:
        dest: /etc/issue.net
        content: |         # Conteúdo do banner (preserva formatação)
          Acesso apenas para pessoas com autorização expressa!!!
        owner: root
        group: root
        mode: '0644'

    # Ativa o banner no SSH
    - name: Ativar banner no SSH
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^Banner'
        line: 'Banner /etc/issue.net'
        state: present

    # Geração de chaves SSH para os usuários
    - name: Gerar chaves SSH para usuários (se não existirem)
      shell: |             
        # Verifica se a chave já existe
        if [ ! -f /home/{{ item }}/.ssh/id_rsa ]; then
          ssh-keygen -t rsa -N "" -f /home/{{ item }}/.ssh/id_rsa
        fi
      loop:
        - caua
        - joao
      become_user: "{{ item }}"  # Executa como o usuário especificado

    #Aplica todas as configurações SSH
    - name: Reiniciar SSH
      systemd:
        name: ssh
        state: restarted   # Reinicia para aplicar mudanças

    # Instala o cliente NFS para montar compartilhamentos remotos
    - name: Instalar cliente NFS
      apt:
        name: nfs-common   # Pacote do cliente NFS no Debian
        state: present

    # Concede privilégios administrativos ao grupo ifpb
    - name: Permitir grupo ifpb usar sudo sem senha
      lineinfile:
        path: /etc/sudoers  # Arquivo de configuração do sudo
        regexp: '^%ifpb'    # Procura configuração existente para o grupo ifpb
        line: '%ifpb ALL=(ALL) NOPASSWD:ALL'  # Permite tudo sem senha
        state: present
        validate: 'visudo -cf %s'  # Valida a sintaxe antes de salvar

  # Handlers para reiniciar serviços quando necessário:
  handlers:
    - name: restart chrony
      systemd:
        name: chrony
        state: restarted

    - name: restart ssh
      systemd:
        name: ssh
        state: restarted
